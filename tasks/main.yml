---
- name: Load disto specific vars
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution }}-{{ ansible_distribution_major_version }}.yml"
    - "{{ ansible_os_family }}.yml"
  tags: [always, glpiinventoryagent]

- name: Include distro specific tasks
  include_tasks: "{{ ansible_os_family }}.yml"
  tags: [always, glpiinventoryagent]


- name: Ensure configuration file is updated
  template:
    src: agent.cfg
    dest: "{{ glpiinventoryagent_configdir }}/{{ glpiinventoryagent_configfile }}"
    mode: 0640
  tags: [always, glpiinventoryagent, cfg]
  register: configfile

#- name: Run tasks after configuration file changes
#  shell: "{{ glpiinventoryagent_full_command }} --debug"
#  tags: [never, glpiinventoryagent, cfg]
#  when: configfile.changed

- name: Ensure daily execution through CRON
  cron:
    name: Glpiinventory run
    state: present
    job: "{{ glpiinventoryagent_full_command }} --debug" 
    hour: '*'
    minute: '*'
    #minute: "{{ 59|random(seed=inventory_hostname) }}"
  tags: [never, glpiinventoryagent, cfg, cron]

- name: Ensure execution through CRON
  cron:
    name: Glpiinventory run
    state: present
    job: "{{ glpi_batch_command }}"
    weekday: '1'
    hour: '*'
    minute: '*'
    #minute: "{{ 59|random(seed=inventory_hostname) }}"
  when: glpi_crontab
